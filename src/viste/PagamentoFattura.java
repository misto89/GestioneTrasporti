/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * PagamentoFattura.java
 *
 * Created on 20-mag-2012, 0.19.14
 */
package viste;

import controllo.FrontController;
import eccezioni.CheckTuttException;
import entita.Fattura;
import entita.Movimento;
import java.sql.Date;
import java.util.LinkedList;
import java.util.List;
import javax.swing.JOptionPane;
import libs.DateUpdate;


/**
 *
 * @author Michele
 */
public class PagamentoFattura extends javax.swing.JDialog {

    public PagamentoFattura() {
    }    
    
    /** Creates new form PagamentoFattura */
//    public PagamentoFattura(java.awt.Frame parent, boolean modal) {
//        super(parent, modal);
//        initComponents();
//        ColorManager color = new ColorManager();
//        color.changeColor(pnlDati);
//    }

    public PagamentoFattura(InsSpedizione aThis, boolean modal) {
        super(aThis, modal);
        initComponents();
        ColorManager color = new ColorManager();
        color.changeColor(pnlDati);
        insSpedizione = aThis;
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jCheckBox1 = new javax.swing.JCheckBox();
        btnOk = new javax.swing.JButton();
        btnAnnulla = new javax.swing.JButton();
        pnlDati = new javax.swing.JPanel();
        jLabel2 = new javax.swing.JLabel();
        txtNote = new javax.swing.JTextField();
        txtMese = new javax.swing.JTextField();
        jLabel4 = new javax.swing.JLabel();
        cboGiorni = new javax.swing.JComboBox();
        jLabel11 = new javax.swing.JLabel();
        chkPagata = new javax.swing.JCheckBox();
        chkForfait = new javax.swing.JCheckBox();
        txtNFatt = new javax.swing.JTextField();
        txtGiorno = new javax.swing.JTextField();
        jLabel9 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel10 = new javax.swing.JLabel();
        txtAnno = new javax.swing.JTextField();
        cboMetPag = new javax.swing.JComboBox();
        jLabel48 = new javax.swing.JLabel();
        jLabel12 = new javax.swing.JLabel();
        jLabel13 = new javax.swing.JLabel();
        jLabel14 = new javax.swing.JLabel();
        txtGiornoScadenza = new javax.swing.JTextField();
        jLabel15 = new javax.swing.JLabel();
        txtMeseScadenza = new javax.swing.JTextField();
        jLabel16 = new javax.swing.JLabel();
        txtAnnoScadenza = new javax.swing.JTextField();

        jCheckBox1.setText("jCheckBox1");

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Modalità di pagamento");
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowOpened(java.awt.event.WindowEvent evt) {
                formWindowOpened(evt);
            }
        });

        btnOk.setBackground(new java.awt.Color(255, 255, 255));
        btnOk.setIcon(new javax.swing.ImageIcon(getClass().getResource("/img/ok.png"))); // NOI18N
        btnOk.setText("OK");
        btnOk.setToolTipText("Completa la fatturazione");
        btnOk.setMargin(new java.awt.Insets(2, -10, 2, 14));
        btnOk.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnOkActionPerformed(evt);
            }
        });

        btnAnnulla.setBackground(new java.awt.Color(255, 255, 255));
        btnAnnulla.setIcon(new javax.swing.ImageIcon(getClass().getResource("/img/annulla.png"))); // NOI18N
        btnAnnulla.setText("Annulla");
        btnAnnulla.setToolTipText("Annulla");
        btnAnnulla.setMargin(new java.awt.Insets(2, -10, 2, 14));
        btnAnnulla.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAnnullaActionPerformed(evt);
            }
        });

        pnlDati.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createEtchedBorder(), "Dati Fattura", javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION, javax.swing.border.TitledBorder.TOP));

        jLabel2.setText("Pagamento");

        txtMese.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtMeseFocusLost(evt);
            }
        });

        jLabel4.setText("Note");

        cboGiorni.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "0", "30", "35", "40", "45", "50", "55", "60", "65", "70", "75", "80", "85", "90", "95", "100", "105", "110", "115", "120" }));
        cboGiorni.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cboGiorniActionPerformed(evt);
            }
        });

        jLabel11.setText("mm");

        chkPagata.setFont(new java.awt.Font("Tahoma", 1, 12));
        chkPagata.setText("Fattura pagata");
        chkPagata.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                chkPagataActionPerformed(evt);
            }
        });

        chkForfait.setFont(new java.awt.Font("Tahoma", 1, 12));
        chkForfait.setText("Fattura forfettaria");

        txtNFatt.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtNFattFocusLost(evt);
            }
        });

        txtGiorno.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtGiornoFocusLost(evt);
            }
        });

        jLabel9.setText("Data Fattura");

        jLabel3.setText("Giorni");

        jLabel10.setText("gg");

        txtAnno.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtAnnoFocusLost(evt);
            }
        });

        jLabel48.setText("# Fattura");

        jLabel12.setText("aaaa");

        jLabel13.setText("Scadenza");

        jLabel14.setText("gg");

        jLabel15.setText("mm");

        jLabel16.setText("aaaa");

        javax.swing.GroupLayout pnlDatiLayout = new javax.swing.GroupLayout(pnlDati);
        pnlDati.setLayout(pnlDatiLayout);
        pnlDatiLayout.setHorizontalGroup(
            pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlDatiLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(pnlDatiLayout.createSequentialGroup()
                        .addComponent(jLabel13)
                        .addGap(29, 29, 29)
                        .addComponent(jLabel14)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtGiornoScadenza, javax.swing.GroupLayout.PREFERRED_SIZE, 32, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jLabel15)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtMeseScadenza, javax.swing.GroupLayout.PREFERRED_SIZE, 31, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel16)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtAnnoScadenza, javax.swing.GroupLayout.PREFERRED_SIZE, 46, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlDatiLayout.createSequentialGroup()
                        .addComponent(jLabel2)
                        .addGap(14, 14, 14)
                        .addComponent(cboMetPag, 0, 262, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(cboGiorni, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jLabel3))
                    .addGroup(pnlDatiLayout.createSequentialGroup()
                        .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(pnlDatiLayout.createSequentialGroup()
                                .addComponent(jLabel9)
                                .addGap(29, 29, 29)
                                .addComponent(jLabel10))
                            .addComponent(jLabel48))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addGroup(pnlDatiLayout.createSequentialGroup()
                                .addComponent(txtGiorno, javax.swing.GroupLayout.PREFERRED_SIZE, 32, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                                .addComponent(jLabel11)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(txtMese, javax.swing.GroupLayout.PREFERRED_SIZE, 31, javax.swing.GroupLayout.PREFERRED_SIZE))
                            .addComponent(txtNFatt))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jLabel12)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtAnno, javax.swing.GroupLayout.PREFERRED_SIZE, 46, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
            .addGroup(pnlDatiLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel4)
                    .addGroup(pnlDatiLayout.createSequentialGroup()
                        .addGap(68, 68, 68)
                        .addComponent(txtNote, javax.swing.GroupLayout.DEFAULT_SIZE, 315, Short.MAX_VALUE)))
                .addGap(47, 47, 47))
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, pnlDatiLayout.createSequentialGroup()
                .addGap(10, 10, 10)
                .addComponent(chkPagata)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 168, Short.MAX_VALUE)
                .addComponent(chkForfait)
                .addContainerGap())
        );

        pnlDatiLayout.linkSize(javax.swing.SwingConstants.HORIZONTAL, new java.awt.Component[] {txtGiorno, txtMese});

        pnlDatiLayout.linkSize(javax.swing.SwingConstants.HORIZONTAL, new java.awt.Component[] {jLabel13, jLabel9});

        pnlDatiLayout.setVerticalGroup(
            pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnlDatiLayout.createSequentialGroup()
                .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel48)
                    .addComponent(txtNFatt, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel9)
                    .addComponent(jLabel10)
                    .addComponent(txtGiorno, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel11)
                    .addComponent(txtMese, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel12)
                    .addComponent(txtAnno, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(33, 33, 33)
                .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(cboGiorni, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(jLabel3))
                    .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel2)
                        .addComponent(cboMetPag, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(18, 18, 18)
                .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel13)
                    .addComponent(jLabel14)
                    .addComponent(txtGiornoScadenza, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel15)
                    .addComponent(txtMeseScadenza, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel16)
                    .addComponent(txtAnnoScadenza, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(29, 29, 29)
                .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel4)
                    .addComponent(txtNote, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(pnlDatiLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(chkPagata)
                    .addComponent(chkForfait))
                .addGap(37, 37, 37))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(pnlDati, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(btnOk, javax.swing.GroupLayout.PREFERRED_SIZE, 75, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 184, Short.MAX_VALUE)
                        .addComponent(btnAnnulla, javax.swing.GroupLayout.PREFERRED_SIZE, 134, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );

        layout.linkSize(javax.swing.SwingConstants.HORIZONTAL, new java.awt.Component[] {btnAnnulla, btnOk});

        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(pnlDati, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnOk)
                    .addComponent(btnAnnulla))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

private void btnAnnullaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAnnullaActionPerformed
// TODO add your handling code here:
    dispose();
}//GEN-LAST:event_btnAnnullaActionPerformed

private void btnOkActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnOkActionPerformed
// TODO add your handling code here:
    int numFattura = Integer.parseInt(txtNFatt.getText());
    String anno = txtAnno.getText();
    String mese = txtMese.getText();
    String giorno = txtGiorno.getText();
    Date dataFattura = null;
    
    if (anno.length() == 2)
        anno = "20" + anno;
    
    if (mese.length() == 1)
        mese = "0" + mese;
    
    if (giorno.length() == 1) 
        giorno = "0" + giorno;
    
    if (anno.isEmpty() || mese.isEmpty() || giorno.isEmpty()) { //Un o più campi fra gg, mm e aaaa non sono stati inseriti
        JOptionPane.showMessageDialog(null, "Inserire la data fattura nel formato gg mm aaaa", 
            "Campo obbligatorio mancante", JOptionPane.ERROR_MESSAGE);
        return;
    }
    
    String annoScad = txtAnnoScadenza.getText();
    String meseScad = txtMeseScadenza.getText();
    String giornoScad = txtGiornoScadenza.getText();
    Date dataScadenza = null;

    if (annoScad.length() == 2)
        annoScad = "20" + annoScad;
    
    if (meseScad.length() == 1)
        meseScad = "0" + meseScad;
    
    if (giornoScad.length() == 1) 
        giornoScad = "0" + giornoScad;
    
    if (annoScad.isEmpty() || meseScad.isEmpty() || giornoScad.isEmpty()) { //Un o più campi fra gg, mm e aaaa non sono stati inseriti
        JOptionPane.showMessageDialog(null, "Inserire la data scadenza nel formato gg mm aaaa", 
            "Campo obbligatorio mancante", JOptionPane.ERROR_MESSAGE);
        return;
    }
    
     /*
     * Se la data non è inserita nel formato corretto, mostra un messaggio di errore.
     * Per formato corretto si intende che il giorno non superi 31, o che il mese non
     * sia superiore a 12, oppure che sia stato inserito il giorno corretto in base al 
     * mese inserito. (es. il 31/11 non esiste)
     */
    try {
        dataFattura = Date.valueOf(anno + "-" + mese + "-" + giorno);
    } catch (IllegalArgumentException e) {
        JOptionPane.showMessageDialog(null, "Valore inserito per la data fattura non valido! Inserire la data nel formato gg/mm/aaaa", 
            "Formato errato", JOptionPane.ERROR_MESSAGE);
            return;
    }
    
    try {
        dataScadenza = Date.valueOf(annoScad + "-" + meseScad + "-" + giornoScad);
    } catch (IllegalArgumentException e) {
        JOptionPane.showMessageDialog(null, "Valore inserito per la data scadenza non valido! Inserire la data nel formato gg/mm/aaaa", 
            "Formato errato", JOptionPane.ERROR_MESSAGE);
            return;
    }
    
    /*int checkValue;
    checkValue = FrontController.checkForcedNumber(dataFattura, numFattura);
    System.out.println(checkValue);
    if (checkValue == -2) {
        JOptionPane.showMessageDialog(null, "La data di fatturazione è inferiore alla fattura precedente, modificala", 
                "Errore data", JOptionPane.ERROR_MESSAGE);
    }else if (checkValue == -1){
        JOptionPane.showMessageDialog(null, "Il numero di fattura inserito è già esistente nell'anno di esercizio", 
                "Errore numero fattura", JOptionPane.ERROR_MESSAGE);
    }else if (checkValue == 1) { */
        String modPag = null;

        if (cboMetPag.getSelectedIndex() > 0) {
            modPag = (String) cboMetPag.getSelectedItem() + "-" + cboGiorni.getSelectedItem();

        } else {
            modPag = cboMetPag.getItemAt(cboMetPag.getItemCount()-1) + "-0";
        }
        String note = txtNote.getText();
        boolean pagata = chkPagata.isSelected();
        boolean forfait = chkForfait.isSelected();
        try {
            FrontController.checkTutt(dataFattura, numFattura);
            insSpedizione.continuaEmissione(numFattura, dataFattura, modPag, pagata, forfait, note, movimenti, dataScadenza, dataPagamento);
            dispose();
            
        } catch (CheckTuttException e) {
            JOptionPane.showMessageDialog(this, e.getMessage(), "Errore", JOptionPane.ERROR_MESSAGE);
        }
        
    
}//GEN-LAST:event_btnOkActionPerformed

private void formWindowOpened(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowOpened
// TODO add your handling code here:
    txtGiorno.setDocument(new JTextFieldLimit(MAX_LENGTH_GIORNO));
    txtMese.setDocument(new JTextFieldLimit(MAX_LENGTH_MESE));
    txtAnno.setDocument(new JTextFieldLimit(MAX_LENGTH_ANNO));
    txtGiornoScadenza.setDocument(new JTextFieldLimit(MAX_LENGTH_GIORNO));
    txtMeseScadenza.setDocument(new JTextFieldLimit(MAX_LENGTH_MESE));
    txtAnnoScadenza.setDocument(new JTextFieldLimit(MAX_LENGTH_ANNO));
    
    String[] metPagam = FrontController.getMetodiPagamento();
    for (String metodo : metPagam)
        cboMetPag.addItem((String) metodo);
    
    cboMetPag.setSelectedItem(metPagam[metPagam.length-1]);
    
    //Inserisce una data presunta della fattura
    java.util.Date utilDate = new java.util.Date();
    String today = (new java.sql.Date(utilDate.getTime())).toString();
    String[] splitted = today.split("\\-");
    String anno = splitted[0];
    String mese = splitted[1];
    String giorno = splitted[2];
    txtAnno.setText(anno);
    txtMese.setText(mese);
    txtGiorno.setText(giorno);
    dataPresunta = Date.valueOf(anno + "-" + mese + "-" + giorno);
    try {
        txtNFatt.setText(String.valueOf(FrontController.checkTutt(dataPresunta, -1)));
        
    } catch (CheckTuttException e) {
        JOptionPane.showMessageDialog(this, e.getMessage(), "Errore", JOptionPane.ERROR_MESSAGE);
    }
    
    String[] nuovaScadenza = DateUpdate.update(dataPresunta, Integer.parseInt((String) cboGiorni.getSelectedItem())).toString().split("-");
    txtGiornoScadenza.setText(nuovaScadenza[2]);
    txtMeseScadenza.setText(nuovaScadenza[1]);
    txtAnnoScadenza.setText(nuovaScadenza[0]);
    
}//GEN-LAST:event_formWindowOpened

private void setNumber() {
    String anno = txtAnno.getText();
    String mese = txtMese.getText();
    String giorno = txtGiorno.getText();
    
    if (anno.length() == 2)
        anno = "20" + anno;
    else if (anno.length() == 3)
        anno = "2" + anno;

    if (mese.length() == 1)
        mese = "0" + mese;

    if (giorno.length() == 1)
        giorno = "0" + giorno;
    
    dataPresunta = Date.valueOf(anno + "-" + mese + "-" + giorno);
    int textNumber = Integer.parseInt(txtNFatt.getText());
    if (forced) {
        try {
            FrontController.checkTutt(dataPresunta, textNumber);
            
        } catch (CheckTuttException e) {
//            JOptionPane.showMessageDialog(this, e.getMessage(), "Errore", JOptionPane.ERROR_MESSAGE);
        }
        
    } else {
        int numCheck;
        try {
            numCheck = FrontController.checkTutt(dataPresunta, -1);
            txtNFatt.setText(String.valueOf(numCheck));
            
        } catch (CheckTuttException e) {
//            JOptionPane.showMessageDialog(this, e.getMessage(), "Errore", JOptionPane.ERROR_MESSAGE);
        }
        
    }
    String[] nuovaScadenza = DateUpdate.update(dataPresunta, Integer.parseInt((String) cboGiorni.getSelectedItem())).toString().split("-");
    txtGiornoScadenza.setText(nuovaScadenza[2]);
    txtMeseScadenza.setText(nuovaScadenza[1]);
    txtAnnoScadenza.setText(nuovaScadenza[0]);
}

private void txtAnnoFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtAnnoFocusLost
    setNumber();
}//GEN-LAST:event_txtAnnoFocusLost


private void txtGiornoFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtGiornoFocusLost
// TODO add your handling code here:
    setNumber();
}//GEN-LAST:event_txtGiornoFocusLost

private void txtMeseFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtMeseFocusLost
// TODO add your handling code here:
   setNumber();
}//GEN-LAST:event_txtMeseFocusLost

void unCheckPagate() {
    chkPagata.setSelected(false);
}

private void txtNFattFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtNFattFocusLost
// TODO add your handling code here:
    //proposedNumber è il numero ottenuto dal sistema sulla base della data all'interno delle text
    int proposedNumber;
    try {
        proposedNumber = FrontController.checkTutt(dataPresunta, -1);
    } catch (CheckTuttException e) {
//       JOptionPane.showMessageDialog(this, e.getMessage(), "Errore", JOptionPane.ERROR_MESSAGE);
       return;
       
    }
    //textNumber è il numero eventualmente inserito all'interno della text
    int textNumber = Integer.parseInt(txtNFatt.getText());
    
    //se i numeri divergono, c'è stata una forzatura da parte dell'utente
    if (textNumber != proposedNumber) {
        forced = true;
        try {
            FrontController.checkTutt(dataPresunta, textNumber);
            
        } catch (CheckTuttException e) {
//            JOptionPane.showMessageDialog(this, e.getMessage(), "Errore", JOptionPane.ERROR_MESSAGE);
//            txtNFatt.requestFocus();
            return;
        }
    }

}//GEN-LAST:event_txtNFattFocusLost

private void chkPagataActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_chkPagataActionPerformed
// TODO add your handling code here:
    if (chkPagata.isSelected()){
        Fattura fatt = new Fattura();
        fatt.setNumero(Integer.parseInt(txtNFatt.getText()));
        fatt.setData(dataPresunta);
        fatt.setCliente(insSpedizione.getCliente());
        
        String anno = txtAnnoScadenza.getText();
        String mese = txtMeseScadenza.getText();
        String giorno = txtGiornoScadenza.getText();
        
        if (anno.isEmpty() || mese.isEmpty() || giorno.isEmpty()) { //Un o più campi fra gg, mm e aaaa non sono stati inseriti
            JOptionPane.showMessageDialog(null, "Inserire tutti i campi per la data", 
                "Campo obbligatorio mancante", JOptionPane.ERROR_MESSAGE);
            return;
        }

        if (anno.length() == 2)
            anno = "20" + anno;
        else if (anno.length() == 3)
            anno = "2" + anno;

        if (mese.length() == 1)
            mese = "0" + mese;

        if (giorno.length() == 1)
            giorno = "0" + giorno;       
        
        
         Date dataScadenza = null;
         try {
             dataScadenza = Date.valueOf(anno + "-" + mese + "-" + giorno);
         } catch (IllegalArgumentException e) {
             JOptionPane.showMessageDialog(this, "Formato data non valido! Inserire la data nel formato gg mm aaaa");
         }
        
        fatt.setDataScadenza(dataScadenza);
        
        Double totale = insSpedizione.getTotale();
        fatt.setTotale(totale);
        String metodoPagamento = null;
        if (cboMetPag.getSelectedIndex() > 0) {
            metodoPagamento = (String) cboMetPag.getSelectedItem() + "-" + cboGiorni.getSelectedItem();
        } else {
            metodoPagamento = cboMetPag.getItemAt(cboMetPag.getItemCount()-1) + "-0";
        }
        fatt.setMetPag(metodoPagamento);

        FrontController.open(new NotePagamento(this, rootPaneCheckingEnabled, fatt)); 
    } else
        movimenti = null;    
}//GEN-LAST:event_chkPagataActionPerformed

private void cboGiorniActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cboGiorniActionPerformed
// TODO add your handling code here:
    String[] nuovaScadenza = DateUpdate.update(dataPresunta, Integer.parseInt((String) cboGiorni.getSelectedItem())).toString().split("-");
    txtGiornoScadenza.setText(nuovaScadenza[2]);
    txtMeseScadenza.setText(nuovaScadenza[1]);
    txtAnnoScadenza.setText(nuovaScadenza[0]);
}//GEN-LAST:event_cboGiorniActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAnnulla;
    private javax.swing.JButton btnOk;
    private javax.swing.JComboBox cboGiorni;
    private javax.swing.JComboBox cboMetPag;
    private javax.swing.JCheckBox chkForfait;
    private javax.swing.JCheckBox chkPagata;
    private javax.swing.JCheckBox jCheckBox1;
    private javax.swing.JLabel jLabel10;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel12;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel14;
    private javax.swing.JLabel jLabel15;
    private javax.swing.JLabel jLabel16;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel48;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JPanel pnlDati;
    private javax.swing.JTextField txtAnno;
    private javax.swing.JTextField txtAnnoScadenza;
    private javax.swing.JTextField txtGiorno;
    private javax.swing.JTextField txtGiornoScadenza;
    private javax.swing.JTextField txtMese;
    private javax.swing.JTextField txtMeseScadenza;
    private javax.swing.JTextField txtNFatt;
    private javax.swing.JTextField txtNote;
    // End of variables declaration//GEN-END:variables
    private InsSpedizione insSpedizione;
    private Date dataPresunta;
    private boolean forced = false;
    
    //Lista temporanea di movimenti
    public List<Movimento> movimenti = new LinkedList<Movimento>();
    //Data pagamento modificata/inserita nella dialog NotePagamento
    public Date dataPagamento = null;    
    
    private static final int MAX_LENGTH_GIORNO = 2;
    private static final int MAX_LENGTH_MESE = 2;
    private static final int MAX_LENGTH_ANNO = 4;

}